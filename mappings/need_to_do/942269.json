[{"code":"class g extends r.il{getMode(){return this.mode}connectWithLibdiscore(e){if(\"typescript\"===this.mode)throw Error(\"connectWithLibdiscore should not be called in TypeScript mode.\");let{storeToken:t,initialState:n}=e.connectStore({storeName:this.getName(),databases:Object.keys(this.state.databases).map(e=>({name:e,type:\"kkv\"}))});return this.applyChanges(n),\"typescript-libdiscore-dual-read\"===this.mode&&this.setupDualReadValidation(),t}setupDualReadValidation(){let e=Symbol(\"didValidatePartition\"),t={root:{},derived:{length:0,memoized:{}}};this.addChangeListener(()=>{let n=this.shadowDatabases;if(null!=n)for(let r in this.state.databases){let i=this.state.databases[r],a=n[r];if(null==a){f.warn(\"Shadow database \".concat(r,\" not found for dual-read validation\"));continue}let s=i.getAllPartitions(),l=a.getAllPartitions();(0,o.R7)(\"\".concat(this.getName(),\":\").concat(r),\"Kkv\",n=>{let r=Object.keys(s),i=Object.keys(l);for(let i of r){let r=s[i];if(!Object.prototype.hasOwnProperty.call(l,i)){n(r,t);continue}let a=l[i],o=r.derived.memoized[e],c=a.derived.memoized[e];if(null!=o&&o===c)continue;n(r,a);let u={};r.derived.memoized[e]=u,a.derived.memoized[e]=u}for(let e of i)Object.prototype.hasOwnProperty.call(s,e)||n(t,l[e])})}})}addKKVDatabase(e,t){let n=new m(this.nextVersion.bind(this));if(this.state.databases[e]=n,this.recordCreators.set(e,null!=t?t:p),null!=this.shadowDatabases){let n=new m(this.nextVersion.bind(this));this.shadowDatabases[e]=n,this.shadowRecordCreators.set(e,null!=t?t:p)}return n}addKVDatabase(e,t){let n=new m(this.nextVersion.bind(this)),r=n.intoKV();if(this.state.databases[e]=n,this.recordCreators.set(e,null!=t?t:p),null!=this.shadowDatabases){let n=new m(this.nextVersion.bind(this));this.shadowDatabases[e]=n,this.shadowRecordCreators.set(e,null!=t?t:p)}return r}applyChanges(e){let t=\"typescript-libdiscore-dual-read\"===this.mode;for(let n of e)this.executeDatabaseChange(n,t)}clearAllDatabases(){for(let e in this.state.databases)this.state.databases[e].clear()}markDirty(){this._nextVersion++}executeDatabaseChange(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],{databaseName:n,opcodes:r}=e,i=this.nextVersion(),a=t?this.shadowDatabases:this.state.databases,o=t?this.shadowRecordCreators:this.recordCreators,s=a[n];if(null==s)throw Error(\"Database \".concat(n,\" does not exist\"));let l=o.get(n);for(let e of r)switch(e.opcode){case\"removePartition\":s.removePartition(e.partitionKey,i);break;case\"setPartition\":{let t=e.partition;for(let e in t)t[e]=l(t[e]);s.setPartition(e.partitionKey,t,i);break}case\"updateRecord\":s.updateRecord(e.partitionKey,e.clusteringKey,e.value,l,i);break;case\"setRecord\":s.setRecord(e.partitionKey,e.clusteringKey,l(e.value),i);break;case\"removeRecord\":s.removeRecord(e.partitionKey,e.clusteringKey,i);break;case\"clearDatabase\":s.clear()}}nextVersion(){return this._nextVersion++}constructor(e,t=\"typescript\"){const n={};if(\"typescript\"===t||\"typescript-libdiscore-dual-read\"===t)for(const t in e){const r=e[t],i=e=>{var t;null!=(t=this.wrappedState)||(this.wrappedState=this.stateWrapper());let n=this._nextVersion;if(r(e,this.wrappedState),this._nextVersion===n)return!1};n[t]=i}super(i.h,n),s(this,\"mode\",void 0),s(this,\"state\",void 0),s(this,\"_nextVersion\",void 0),s(this,\"recordCreators\",void 0),s(this,\"wrappedState\",void 0),s(this,\"shadowDatabases\",void 0),s(this,\"shadowRecordCreators\",void 0),this.mode=t,this._nextVersion=0,this.recordCreators=new Map,this.wrappedState=null,this.shadowDatabases=null,this.shadowRecordCreators=null,this.state={databases:{}},\"typescript-libdiscore-dual-read\"===t&&(this.shadowDatabases={},this.shadowRecordCreators=new Map)}}"}]