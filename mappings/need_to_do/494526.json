[{"code":"function R(e){let{authTokenCallback:t,conditionalMediationAbortController:n}=e,s=(0,l.e7)([x.default],()=>x.default.getIsPasswordlessActive()),{state:u,rsaKeyPair:d,cancel:g,handleFailure:m}=function(e){let[t,n]=i.useState(0),[r,s]=i.useState(!1),[l,o]=i.useState({step:0}),[c,u]=i.useState(null),d=(0,h.Z)(),g=i.useMemo(()=>new a.Z(1500,3e4),[]),m=(0,f.Z)(()=>{o({step:0}),d?n(e=>e+1):(T.info(\"document is not visible, will defer reconnection when document becomes visible.\"),s(!0))}),p=i.useCallback(()=>{T.error(\"Could not complete QR code login, trying to restart with a new QR code.\"),o({step:0}),g.pending||g.fail(m)},[m,g]);return i.useEffect(()=>{d&&r&&0===l.step&&(T.info(\"reconnecting, now that document is visible\"),s(!1),n(e=>e+1))},[l,d,r,s]),i.useEffect(()=>{let t=Date.now(),n=\"\".concat(window.GLOBAL_ENV.REMOTE_AUTH_ENDPOINT,\"/?v=2\");n.startsWith(\"//\")&&(n=\"wss:\".concat(n));let r=new WebSocket(n);T.info(\"[0ms] connecting to \".concat(n));let i=e=>T.info(\"[\".concat(\"\".concat(Date.now()-t,\"ms\"),\"] \").concat(e)),s=null,a=null,l=null,c=null,d=!0;function h(){if(null!=s)return s;throw Error(\"No key pair set\")}let f=()=>{d?(d=!1,r.send(JSON.stringify({op:\"heartbeat\"}))):(i(\"heartbeat timeout, reconnecting.\"),r.close(),p())};return r.onmessage=async t=>{let{data:n}=t,s=JSON.parse(n);switch(s.op){case\"nonce_proof\":{let e=s.encrypted_nonce,t=await (0,v.qd)(h(),e);i(\"computed nonce proof\"),r.send(JSON.stringify({op:\"nonce_proof\",nonce:t}));return}case\"pending_remote_init\":{g.succeed(),_.S.dispatch(I.CkL.WAVE_EMPHASIZE);let e=await (0,v.Pk)(h());if(e!==s.fingerprint)throw Error(\"bad fingerprint \".concat(e,\" !== \").concat(s.fingerprint));i(\"handshake complete awaiting remote auth.\"),o({step:1,fingerprint:e});return}case\"pending_login\":{let e=s.ticket;null==e&&p(),o({step:4,ticket:e});return}case\"pending_ticket\":{_.S.dispatch(I.CkL.WAVE_EMPHASIZE),i(\"remote auth handshake started, awaiting ticket/cancel.\");let e=s.encrypted_user_payload;o({step:3,user:await (0,v.Rq)(h(),e)});return}case\"pending_finish\":{_.S.dispatch(I.CkL.WAVE_EMPHASIZE),i(\"remote auth handshake started, awaiting finish/cancel.\");let e=s.encrypted_user_payload;o({step:2,user:await (0,v.Rq)(h(),e)});return}case\"finish\":{_.S.dispatch(I.CkL.WAVE_EMPHASIZE),i(\"remote auth handshake finished.\");let t=s.encrypted_token;o({step:5}),e(await (0,v.FW)(h(),t),await (0,v.Pk)(h()));return}case\"cancel\":i(\"remote auth handshake cancelled.\"),m();return;case\"hello\":{i(\"got hello, auth timeout=\".concat(s.timeout_ms,\"ms\"));let e=s.heartbeat_interval;c=setTimeout(()=>{c=null,f(),l=setInterval(f,e)},Math.floor(e*Math.random()));return}case\"heartbeat_ack\":d=!0}},r.onopen=async()=>{s=await (0,v.W_)(),a=await (0,v.dK)(s);let e=await (0,v.Pk)(s);i(\"connected, handshaking with fingerprint: \".concat(e)),r.send(JSON.stringify({op:\"init\",encoded_public_key:a})),u(s)},r.onclose=e=>{i(\"disconnected, code: \".concat(e.code,\" \").concat(e.reason)),p()},r.onerror=e=>{i(\"disconnected, error: \".concat(JSON.stringify(e))),p()},()=>{i(\"cleaning up\"),r.onopen=()=>null,r.onmessage=()=>null,r.onclose=()=>null,r.onerror=()=>null,r.close(1e3),g.cancel(),null!=c&&clearTimeout(c),null!=l&&clearInterval(l)}},[m,e,t,g,p]),{state:l,rsaKeyPair:c,cancel:m,handleFailure:p}}(t),p=function(e){switch(e){case 0:case 1:return 0;case 3:case 2:case 4:case 5:return 1}}(u.step);return i.useEffect(()=>{4===u.step&&null!=u.ticket&&o.tn.post({url:I.ANM.REMOTE_AUTH_LOGIN,body:{ticket:u.ticket},oldFormErrors:!0,rejectWithError:!0}).then(async e=>{if(null!=d)try{let n=await (0,v.FW)(d,e.body.encrypted_token),r=await (0,v.Pk)(d);t(n,r)}catch(e){m()}else m()}).catch(()=>{m()})},[u,t,d,m]),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(\"div\",{className:S.verticalSeparator}),(0,r.jsx)(c.qBt,{fillParent:!0,className:S.qrLogin,step:p,steps:[0,1],children:(0,r.jsx)(\"div\",{className:S.qrLoginInner,children:(0,r.jsx)(P,{state:u,cancel:g,conditionalMediationAbortController:n,isPasswordlessActive:s})})})]})}"}]