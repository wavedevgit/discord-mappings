[{"code":"function P(e){let{authTokenCallback:t,conditionalMediationAbortController:n}=e,s=(0,a.bG)([m.default],()=>m.default.getIsPasswordlessActive()),{state:d,rsaKeyPair:u,cancel:g,handleFailure:_}=function(e){let[t,n]=i.useState(0),[r,s]=i.useState(!1),[a,o]=i.useState({step:0}),[c,d]=i.useState(null),u=(0,h.A)(),g=i.useMemo(()=>new l.A(1500,3e4),[]),_=(0,p.A)(()=>{o({step:0}),u?n(e=>e+1):(C.info(\"document is not visible, will defer reconnection when document becomes visible.\"),s(!0))}),f=i.useCallback(()=>{C.error(\"Could not complete QR code login, trying to restart with a new QR code.\"),o({step:0}),g.pending||g.fail(_)},[_,g]);return i.useEffect(()=>{u&&r&&0===a.step&&(C.info(\"reconnecting, now that document is visible\"),s(!1),n(e=>e+1))},[a,u,r,s]),i.useEffect(()=>{let t=Date.now(),n=\"\".concat(window.GLOBAL_ENV.REMOTE_AUTH_ENDPOINT,\"/?v=2\");n.startsWith(\"//\")&&(n=\"wss:\".concat(n));let r=new WebSocket(n);C.info(\"[0ms] connecting to \".concat(n));let i=e=>C.info(\"[\".concat(\"\".concat(Date.now()-t,\"ms\"),\"] \").concat(e)),s=null,l=null,a=null,c=null,u=!0;function h(){if(null!=s)return s;throw Error(\"No key pair set\")}let p=()=>{u?(u=!1,r.send(JSON.stringify({op:\"heartbeat\"}))):(i(\"heartbeat timeout, reconnecting.\"),r.close(),f())};return r.onmessage=async t=>{let{data:n}=t,s=JSON.parse(n);switch(s.op){case\"nonce_proof\":{let e=s.encrypted_nonce,t=await (0,E.lU)(h(),e);i(\"computed nonce proof\"),r.send(JSON.stringify({op:\"nonce_proof\",nonce:t}));return}case\"pending_remote_init\":{g.succeed(),A._.dispatch(y.jej.WAVE_EMPHASIZE);let e=await (0,E.Fs)(h());if(e!==s.fingerprint)throw Error(\"bad fingerprint \".concat(e,\" !== \").concat(s.fingerprint));i(\"handshake complete awaiting remote auth.\"),o({step:1,fingerprint:e});return}case\"pending_login\":{let e=s.ticket;null==e&&f(),o({step:4,ticket:e});return}case\"pending_ticket\":{A._.dispatch(y.jej.WAVE_EMPHASIZE),i(\"remote auth handshake started, awaiting ticket/cancel.\");let e=s.encrypted_user_payload;o({step:3,user:await (0,E.n7)(h(),e)});return}case\"pending_finish\":{A._.dispatch(y.jej.WAVE_EMPHASIZE),i(\"remote auth handshake started, awaiting finish/cancel.\");let e=s.encrypted_user_payload;o({step:2,user:await (0,E.n7)(h(),e)});return}case\"finish\":{A._.dispatch(y.jej.WAVE_EMPHASIZE),i(\"remote auth handshake finished.\");let t=s.encrypted_token;o({step:5}),e(await (0,E.S4)(h(),t),await (0,E.Fs)(h()));return}case\"cancel\":i(\"remote auth handshake cancelled.\"),_();return;case\"hello\":{i(\"got hello, auth timeout=\".concat(s.timeout_ms,\"ms\"));let e=s.heartbeat_interval;c=setTimeout(()=>{c=null,p(),a=setInterval(p,e)},Math.floor(e*Math.random()));return}case\"heartbeat_ack\":u=!0}},r.onopen=async()=>{s=await (0,E.T8)(),l=await (0,E.Jn)(s);let e=await (0,E.Fs)(s);i(\"connected, handshaking with fingerprint: \".concat(e)),r.send(JSON.stringify({op:\"init\",encoded_public_key:l})),d(s)},r.onclose=e=>{i(\"disconnected, code: \".concat(e.code,\" \").concat(e.reason)),f()},r.onerror=e=>{i(\"disconnected, error: \".concat(JSON.stringify(e))),f()},()=>{i(\"cleaning up\"),r.onopen=()=>null,r.onmessage=()=>null,r.onclose=()=>null,r.onerror=()=>null,r.close(1e3),g.cancel(),null!=c&&clearTimeout(c),null!=a&&clearInterval(a)}},[_,e,t,g,f]),{state:a,rsaKeyPair:c,cancel:_,handleFailure:f}}(t),f=function(e){switch(e){case 0:case 1:return 0;case 3:case 2:case 4:case 5:return 1}}(d.step);return i.useEffect(()=>{4===d.step&&null!=d.ticket&&o.Bo.post({url:y.Rsh.REMOTE_AUTH_LOGIN,body:{ticket:d.ticket},oldFormErrors:!0,rejectWithError:!0}).then(async e=>{if(null!=u)try{let n=await (0,E.S4)(u,e.body.encrypted_token),r=await (0,E.Fs)(u);t(n,r)}catch(e){_()}else _()}).catch(()=>{_()})},[d,t,u,_]),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(\"div\",{className:O.AC}),(0,r.jsx)(c.YC2,{fillParent:!0,className:O.ZF,step:f,steps:[0,1],children:(0,r.jsx)(\"div\",{className:O.vP,children:(0,r.jsx)(w,{state:d,cancel:g,conditionalMediationAbortController:n,isPasswordlessActive:s})})})]})}"}]