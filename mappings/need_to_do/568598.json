[{"code":"class x{get version(){return this.participantByIndex.version}size(e){return this.participantByIndex.size(e)}toArray(e){return this.participantByIndex.values(e,!0)}rebuild(){let e=f.A.getChannel(this.channelId);if(null==e||e.type===O.rbe.GUILD_TEXT||(this.call=d.A.getCall(this.channelId),e.isPrivate()&&(null==this.call||this.call.unavailable)))return!1;let t=new Set(e.isGuildVocalOrThread()?Object.keys(g.A.getVoiceStatesForChannel(e.id)):e.recipients);return t.add(u.default.getId()),this.guildRingingUsers.size>0&&(t=new Set([...t,...this.guildRingingUsers])),c.A.getAllActiveStreamsForChannel(this.channelId).forEach(e=>{let{ownerId:n}=e;return t.add(n)}),this.participantByIndex.clear(),this.participants={},t.forEach(e=>this.updateParticipant(e)),this.updateEmbeddedActivities(),!0}getParticipant(e){var t;return null!=(t=this.participantByIndex.get(e))?t:null}updateEmbeddedActivities(){return this.updateParticipant(C)}hasEmbeddedActivity(){return this.size(\"ACTIVITY\")>0}updateParticipant(e){let t=this.participants[e],n=e===C?this._getParticipantsForEmbeddedActivities():this._getParticipantsForUser(e);return(null!=t||0!==n.length)&&(null==t||t.forEach(e=>{this.participantByIndex.delete(e.id)}),n.forEach(e=>{this.participantByIndex.set(e.id,e)}),this.participants[e]=n,!0)}updateParticipantSpeaking(e){var t,n;return null!=(t=null==(n=this.participants[e])?void 0:n.reduce((t,n)=>{if(n.type===b.lp.USER){let t=(0,a.R)({userId:e,checkIsMuted:!0});return t&&(this.lastSpoke[e]=Date.now()),this.participantByIndex.set(n.id,T(I({},n),{speaking:t,voiceDb:_.A.getVoiceVolume(e),latched:D(e),lastSpoke:this.lastSpoke[e],soundsharing:_.A.isSoundSharing(e)})),!0}return t},!1))&&t}updateParticipantQuality(e,t,n){var r,i;return null!=(r=null==(i=this.participants[e])?void 0:i.reduce((e,r)=>r.type===b.lp.STREAM?(this.participantByIndex.set(r.id,T(I({},r),{maxResolution:t,maxFrameRate:n})),!0):e,!1))&&r}updateGuildRingingUsers(e,t){t?this.guildRingingUsers.add(e):this.guildRingingUsers.delete(e)}updateParticipantPoppedOut(e,t){t?this.poppedOutParticipants.add(e):this.poppedOutParticipants.delete(e)}_getEmbeddedActivities(){let e=s.Ay.getEmbeddedActivitiesForChannel(this.channelId),t=s.Ay.getSelfEmbeddedActivityForChannel(this.channelId);return null==t?e:(0,r.uniqBy)([...e,t],e=>e.compositeInstanceId)}_getParticipantsForEmbeddedActivities(){return this._getEmbeddedActivities().map((e,t)=>{var n,r,i;return{type:b.lp.ACTIVITY,id:N({applicationId:e.applicationId,instanceId:e.compositeInstanceId}),applicationId:e.applicationId,activityType:O.$pd.PLAYING,activityUrl:e.url,participants:[...null!=(n=e.participants)?n:[]],guildId:null!=(r=null==(i=f.A.getChannel(this.channelId))?void 0:i.getGuildId())?r:null,sortKey:t.toString()}})}_getParticipantsForUser(e){var t,n,r,i,s,d;let y,O,A=[],S=h.default.getUser(e);if(null==S)return A;let C=g.A.getVoiceStateForChannel(this.channelId,e),N=g.A.getVoicePlatformForChannel(this.channelId,e),w=f.A.getChannel(this.channelId),R=null==w?void 0:w.getGuildId(),P=null!=(t=(null==(i=this.call)||null==(r=i.ringing)?void 0:r.includes(e))||this.guildRingingUsers.has(e))&&t;(null!=C||P)&&(y=T(I({type:b.lp.USER},m.A.getUserStreamData(e,R)),{user:S,id:S.id,voiceState:C,voicePlatform:N,speaking:(0,a.R)({userId:e,checkIsMuted:!0}),voiceDb:_.A.getVoiceVolume(e),latched:D(e),lastSpoke:null!=(s=this.lastSpoke[e])?s:0,soundsharing:_.A.isSoundSharing(e),ringing:P,userNick:E.Ay.getName(R,this.channelId,S),userAvatarDecoration:(0,o.U)(S,R),localVideoDisabled:p.A.isLocalVideoDisabled(S.id),isPoppedOut:this.poppedOutParticipants.has(S.id)}),A.push(y));let x=null!=(n=c.A.getStreamForUser(e,R))?n:c.A.getActiveStreamForUser(e,R);if(null!=x&&x.channelId===this.channelId){let t=(0,l._z)(x),n=this.getParticipant(t),r=x.ownerId===u.default.getId()&&c.A.isSelfStreamHidden(this.channelId),i=(null==n?void 0:n.type)===b.lp.STREAM?{maxResolution:null!=n.maxResolution?I({},n.maxResolution):void 0,maxFrameRate:n.maxFrameRate}:null;O=T(I({},m.A.getUserStreamData(e,R,v.x.STREAM),i),{type:r?b.lp.HIDDEN_STREAM:b.lp.STREAM,id:t,userVideo:null!=(d=null==C?void 0:C.selfVideo)&&d,user:S,userNick:E.Ay.getName(R,this.channelId,S),stream:x,isPoppedOut:this.poppedOutParticipants.has(t)}),A.push(O)}return A}constructor(e){A(this,\"channelId\",void 0),A(this,\"call\",void 0),A(this,\"participants\",{}),A(this,\"lastSpoke\",{}),A(this,\"guildRingingUsers\",new Set),A(this,\"poppedOutParticipants\",new Set),A(this,\"participantByIndex\",new i.J(e=>{var t;let n=[];return e.type===b.lp.USER&&e.speaking&&n.push(\"SPEAKING\"),e.type===b.lp.USER&&(null==(t=e.voiceState)?void 0:t.selfVideo)?(n.push(\"VIDEO\"),e.localVideoDisabled||e.isPoppedOut||n.push(\"FILTERED\")):(0,b.Ay)(e)&&(n.push(\"STREAM\"),e.type===b.lp.HIDDEN_STREAM||null==e.streamId||e.isPoppedOut||n.push(\"FILTERED\")),e.type===b.lp.ACTIVITY&&n.push(\"ACTIVITY\"),\"isPoppedOut\"in e&&e.isPoppedOut||n.push(\"NOT_POPPED_OUT\"),n},w)),this.channelId=e}}"},{"code":"function w(e){switch(e.type){case b.lp.ACTIVITY:return\"\\x01\".concat(e.sortKey);case b.lp.HIDDEN_STREAM:case b.lp.STREAM:return\"\".concat(e.userVideo?\"\\x02\":\"\\x03\").concat((0,y.A)(e.userNick,e.user),\"\\x03\");case b.lp.USER:var t,n;let r=\"\\x05\";return(null==(t=e.voiceState)?void 0:t.selfVideo)?r=\"\\x03\":(null==(n=e.voiceState)?void 0:n.selfStream)&&(r=\"\\x04\"),\"\".concat(r).concat((0,y.A)(e.userNick,e.user))}}"},{"code":"function N(e){let{applicationId:t,instanceId:n}=e;return null!=n?\"activity-\".concat(t,\"-\").concat(n):\"activity-\".concat(t)}"},{"code":"function R(e,t){let[,n]=e,[,r]=t;return n===r}"}]